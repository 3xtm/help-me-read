<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Purchase cancelled.</title>
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script src="../common.js"></script>
    <link rel="stylesheet" type="text/css" href="./style.css">

    <script>
		$( function() {
			const langSelect = $( '#lang' );
			var defaultLang = 'en';
			if ( navigator.language && translations.hasOwnProperty( navigator.language ) ) {
				defaultLang = navigator.language;
			}
			initTranslations( defaultLang );
			Object.keys( translations ).forEach( function ( lang ) {
				const option = $( '<option value="' + lang + '">' + translations[lang].langName + '</option>' );
				if ( lang === defaultLang ) {
					option.attr( 'selected', '' );
				}
				$('#lang').append( option );
			} );

			const urlParams = new URLSearchParams( window.location.search );
			const checkout_sesion = urlParams.get( 'session_id' );
			function doPoll(){
				$.get( 'https://help-me-read-this.appspot.com/checkout/get?session_id=' + checkout_sesion, function( data ) {
					var d = JSON.parse( data );
					if ( d.error ) {
						$( '#updates' ).html( 'Something went wrong! Please email <a href="mailto:support@helpmereadthis.com">support@helpmereadthis.com</a>' );
						return;
					}
					if ( d.status === 'active' && d.token ) {
						$( '#token' ).val( d.token );
						$( 'button' ).attr( 'disabled', false );
						$( '#updates' ).text( '✅ Your payment completed successfully' );
						return;
					}
					setTimeout( doPoll, 3000 );
				});
			}
            if( checkout_sesion ) {
                doPoll();
            } else {
            	$( '#updates' ).html( 'Something went wrong! Please email <a href="mailto:support@helpmereadthis.com">support@helpmereadthis.com</a>' );
            }
		} );

    </script>
</head>

<body>
<h2>✅ Thank you for purchasing token!</h2>

<form action="../app.html" method="get" >
<p>The language you select here will be hardcoded, so that the person using this will always default to one language. This is to prevent accidental language switching for voice synthesis.</p>
<select name="lang" id="lang"></select>
<input type="hidden" name="token" id="token">
<h3>After clicking the button below, you will be redirected to the App. Remeber to save it on Homescreen for easy access:</h3>
<ul>
    <li>IOS: Share->Add to Homescreen</li>
    <li>Android: Top-right menu in Chrome->Add to Homescreen</li>
</ul>
<p id="updates">Verifying your payment...</p>
    <button type="submit" disabled="true" class="button">Go to the App</button>
</form>

</body>

</html>